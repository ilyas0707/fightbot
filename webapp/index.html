<head><meta name='viewport'content='width=device-width,initial-scale=1'></head>
<style>body {width:100%;height:100%;margin:0px;}</style>
<canvas id='c'/>
<script>
const BACKGROUND = '#E3F2FD'
const OUTER_CIRCLE = '#7986CB'
const INNER_CIRCLE = '#3F51B5'
const PRESSED_CIRCLE = '#303F9F'
const CIRCLE_SIZE = 0.7
const SEND_INTERVAL = 300

var canvas = document.getElementById('c')
var ctx = canvas.getContext('2d')

var mouseX = 0
var mouseY = 0
var width = 0
var height = 0
var joyX = 0
var joyY = 0
var cx = 0
var cy = 0
var mouseDown = false
var lastSendTime = 0

init()

function init() {
  canvas.addEventListener('mousedown', mousedown, false)
  canvas.addEventListener('touchstart', mousedown, false)
  canvas.addEventListener('mousemove', mousemove, false)
  canvas.addEventListener('touchmove', mousemove, false)
  canvas.addEventListener('mouseup', mouseup, false)
  canvas.addEventListener('touchend', mouseup, false)
  process()
  window.addEventListener('resize', onresize)
  onresize()

  process()
}


function onresize() {
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight
  width = canvas.width
  height = canvas.height
  cx = canvas.width/2
  cy = canvas.height/2
}


function mousedown(ev) {
  mouseDown = true
  if (ev.changedTouches != undefined)
    ev.preventDefault()
  console.log('mousedown', ev)
  mousemove(ev)
}

function mousemove(ev) {
  if (!mouseDown) return
  console.log('mousemove', ev)

  if (ev.changedTouches != undefined)
    ev.preventDefault()

  if (ev.changedTouches != undefined) {
    mouseX = ev.changedTouches[0].pageX
    mouseY = ev.changedTouches[0].pageY
  } else {
    mouseX = ev.x
    mouseY = ev.y
  }
  console.log('mousemove', ev)
}

function mouseup(ev) {
  console.log('mouseup')
  if (ev.changedTouches != undefined)
    ev.preventDefault()
  mouseDown = false
}


function process() {
  processJoystick()
  sendToServer()
  draw()
  window.requestAnimationFrame(process)
}

function sendToServer() {
  var time = new Date().getTime()
  if (time - lastSendTime < SEND_INTERVAL) return

  // TODO send to the webserver

  lastSendTime = time
}

function processJoystick() {
  var r = Math.min(width, height) /2*CIRCLE_SIZE
  var currDst = dst(mouseX, mouseY, cx, cy)
  if (currDst > r) {
    joyX = (mouseX-width/2) * (r/currDst) + width/2
    joyY = (mouseY-height/2) * (r/currDst) + height/2
  } else {
    joyX = mouseX
    joyY = mouseY
  }
  if (!mouseDown) {
    joyX = cx
    joyY = cy
  }


}
function draw() {
  // clear the canvas
  ctx.fillStyle = BACKGROUND
  ctx.fillRect(0,0,width,height)


  drawCircle(CIRCLE_SIZE, cx, cy, OUTER_CIRCLE, false)
  drawCircle(0.3, joyX, joyY, INNER_CIRCLE, true)
}

function drawCircle(radf, x, y, color, fill) {
  ctx.beginPath()
  var r = Math.min(width, height) /2*radf
  ctx.arc(x, y, r,0,2*Math.PI)
  ctx.lineWidth = 3
  ctx.strokeStyle = color
  ctx.fillStyle = color
  if (fill) ctx.fill()
  else ctx.stroke()
}

function dst(x, y, x2, y2) {
  const dx = x2-x;
  const dy = y2-y;
  return Math.sqrt(dx*dx+dy*dy)
}
</script>
